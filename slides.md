TODO

- Расписать у решений плюсы/минусы

---

## Гарри Поттер

## и

## скриншотные тесты

NOTE: Всем привет. Поднимите руки кто знает что-нибудь про скриншотные тесты. А теперь те кто использует их у себя в проекте. Много народу: Круто что многие используют их, наверняка вы сталкивались с проблемами когда внедряли их, я кратко пробегусь по ним и то как их можно решить в конце расскажу какой путь выбралив контуре. Мало народу: Не густо, возможно у меня получится кого-нибудь из вас вдохновить внедрить к себе скриншотные тесты.

---

## Про себя

Фото и небольшое био

NOTE: Меня зовут Дима Лазарев. Я работаю фронтендером в Контуре 3.5 года. Пилю всякие сложные инфраструктурные штуки. Веду внутренний подкаст о фронте. В данный момент работаю тимлидом в команде "Инфраструктура фронтенда".

---

## Инфраструктура фронтенда

Помощь командам в налаживании

- Тестирование
- Сборка
- Общие компоненты/библиотеки

NOTE: Чем занимается наша команда. Мы создаем инструменты для тестирования и ускорения старта разработки новых проектов, аккумулируем лучшие практики и занимаемся разработкой общих библиотек и компонентов. Основные нашие продукты, это Контур.Гайды.

---

## Контур.Гайды

Скриншот

NOTE: Контур.Гайды, это дизайн система с описанием логики работы контролов и общими рекомендациями к проектированию интерфейсов. Помогая тем самым проектировщикам создавать интерфейсы продуктов в едином стиле. На основе гайдов мы разрабатываем библиотеку общих компонентов react-ui.

---

## react-ui

Скриншот

NOTE: Opensource библиотека базовых react компонентов, реализованных согласно гайдам. Большинство команд используют их для создания интерфейса продуктов. Для нас как инфраструктурной команды важно уметь быстро выкатывать фичи в компонентах и не увеличивать кол-во багов. Это напрямую отражается на скорости выкатывания фич в продуктах и удовлетворенности пользователей. Поэтому мы используем у себя скриншотные тесты.

---

## Скриншотные тесты

- Автоматизация тестирования верстки
- Проверка визуального отображения в разных браузерах

NOTE: Основная цель скриншотных тестов, автоматизация тестирования верстки и проверка визуального отображения в разных браузерах. Тем самым меняя код компонента мы можем быть уверены, что ничего не сломали в существующих сценариях использования. Если у вас в проекте есть переиспользуемые компоненты, то скриншотное тестирование значительно облегчит жизнь вам и вашим тестировщикам. Звучит неплохо. Рассмотрим на примере гипотетического проекта с чем можно столкнуться при попытке внедрить скриншотные тесты. Начинается всё с того что в один прекрасный момент к вам приходит тестер со словами.

---

## Я задолбался...

- gif

NOTE: Я задолбался... С каждым релизом вручную протыкивать в разных браузерах странички сервиса, заполнять формочки и проверять что ничего не уехало. Зачастую из-за замыленного глаза пропускать баги в релиз. Вы решаете что пришло время внедрить скриншотные тесты.

---

## Исходные данные

- Наличие E2E тестов
- Тесты гоняются локально и в CI
- Разработчики используют Storybook

NOTE: Допустим что в нашем гипотетическом проекте уже есть E2E тесты, проверяющие различные пользовательские сценарии. Эти тесты можно запустить локально и они гоняются в CI. Разработчики в проекте используют Storybook для разработки компонентов или частей интерфейса.

---

## Наивное решение

- Внедряем скриншотные тесты в существующие E2E

NOTE: Первый логичным шагом выглядит попытка внедрить скриншотные тесты в существующие e2e тесты. Так как уже есть какая-то инфраструктура для тестов. В этих тестах загружатся реальный интерфейс сервиса, прокликиваются основные страницы. Кажется вот оно, добавляем в тесты снятие скриншотов и попиксельное сравнение картинок. Но сразу обнаруживаем что

---

## Чувствительность к окружению

Скриншот

NOTE: Скриншоты интерфейса экстенра сделаных в разных окружениях. Вы видете разницу?

---

## Чувствительность к окружению

diff

NOTE: А она есть.

---

## Чувствительность к окружению

- Браузер и версии
- Шрифты
- ОС и настройки ОС
- Видеокарта
- Фаза луны, настроение тестировщика и тд

NOTE: На результат влияет очень много факторов. Начиная с разных браузеров, их версий, операционной системы, шрифтов, заканчивая видеокартой, порой даже кажется что на это влияет фаза луны или настроение тестировщика. Было наивно думать что всё будет так просто, пока у нас ещё есть энтузиазм, попытаемся найти решение этой проблемы.

---

## Всегда гонять на одной тачке

- Не распараллелить
- Тяжело дебажить
- Без CI

NOTE: Во-первых мы можем на уровне договоренностей в команде ограничить запуск скриншотных тестов одной тачкой, например на тачке тестера, дешево и сердито. Это вполне себе решение на какое-то время. Но про нормальный дебаг можно забыть. Хочется какого-то человеческого решения.

---

## Сравнивать prod и dev

- В два раза больше времени или ресурсов
- Тесты почти всегда красные

NOTE: Можно попробовать не хранить эталонные скриншоты в репа, а генерировать на основе продакшен и разрабатываемой версии сервиса и сравнивать эти скриншоты. Тут есть такие нюансы, что на прогон надо тратить или в два раза больше времени или ресурсов. А ещё у нас отсутствует какой-либо механизм аппура. Например при законном изменении, добавление кнопки на форму, скриншоты гарантированно будут разваливаться, до тех пор пока не выкатится в прод новая версия. Пытаясь решить проблему сравнения скриншотов отрендериных в разных окружениях нас посещает мысль, а может быть нам хранить в качестве эталона не картинку, а исходных html из которого наш браузер будет рендерить скриншот.

---

## Сохранять HTML как эталон

- Кроме html надо сохранять ещё css
- А ещё и состояние полей ввода
- И ховер
- И скролл
- Есть шанс ложно-положительного срабатывания

NOTE: Мы решаем проблему с окружением, так как всегда рендерим скриншот из эталонного HTML и скриншот тестируемой страницы. Правда одного только HTML недостаточно, надо сохранять CSS, а ещё состояние полей ввода, и ховер, и скролл. Ещё что-то? Вообще решение вполне себе рабочие, если устаканить некоторые нюансы. Правда таким образом можно поймать ложно-положительное срабатывание. Например при обновлении версии браузера может поехать верстка, а из-за того что исходный код страницы не изменился, мы не увидим проблему.

---

## Machine Learning TODO

- Модный тренд
- Можно уменьшить кол-во ложных срабатываний
- Нужно много вкладываться в R&D

NOTE: 

---

## Virtual Machine To the Rescue TODO

- Детерминированное окружение
- Легко масштабируется

NOTE: 

---

## After a few months...

NOTE: Допустим мы как-то побороли проблему с окружением, репортовали на очередном скраме об успешном внедрении скриншотных тестов. Началась будничная рутина и спустя какое-то время начинает копиться некоторая неудовлетворенность.

---

## Тяжело поддерживать

- Медленные E2E тесты

NOTE: Оказывается их тяжело поддерживать. Причинами того является то что E2E тесты очень медленные по своей природе. Так как E2E тесты подразумевают тестирование конечного сервиса конечным пользователем, отсюда и название end-to-end. Для этого в каждом тесте обязательно происходит старт сервиса, инициализация БД, прогрев, авторизация в сервисе. Зачастую тесты это какой-то сценарий с заполнением нескольких форм и чтобы получить скриншот последней формы, нам всегда нужно проходить весь сценарий целиком.

---

## Тяжело поддерживать

- Медленные E2E тесты
- Избыточные скриншоты

NOTE: Другой причиной является то что получаемые скриншоты обладают большим уровнем избыточности. На странице кроме тестируемой формы может распалогаться множество других элементов интерфейса и этим элементы могут дублироваться на других страницах. Например шапка сервиса. При изменении шапки нам необходимо переапрувливать большую часть скриншотов. Начинает закрадываться мысль, может

---

## Ну их нафиг...

NOTE: Ну их нафиг. Жили же как-то до этого.

---

## Storybook

---

 ## Попытка номер два

- Виртуалки для детерминированного окружения
- Storybook для изолированного тестирования компонентов

NOTE: Мы поняли что существующая инфраструктура с тестами нам не подходит, нужно создавать отдельную конкретно под скриншотные тесты. Посмотрим, что можно взять из существующих решений.

---

## НЕсколько слайдов с разными либами

Скриншот с https://github.com/mojoaxel/awesome-regression-testing

---

## Нет коробочного решения

- API для управления браузером (Selenium/Puppeteer/TestCafe)
- Сравнялка скриншотов

NOTE: Условно все существующие библиотеки можно разделить на следующие категории

---

## Нет коробочного решения

- Куча разных библиотек и фреймворков каждая со своими особенностями

- Gemini/hermione
- Jest-image-snapshot
- webdriverio
- puppeter
- Pixelmatch
- Сервисы

NOTE: расписать под каждое решение

---

## Минусы gemini

- Старый webdriver
- Зависимость от windows-build-tools
- Неудобный дифф
- Медленный
- Нет TypeScript
- Задеприкейчен

---

## Альтернатива Hermione

- Ничуть не лучше
- Всё тоже самое, только может ведбрайвер чуть посвежее
- И API в профиль

NOTE: Mocha как парсер тестов WUT?

---

## Причем тут Гарри Поттер

- Hermione вызывает ассоциации со вселенной Гарри Поттера
- Так как мы делаем своё решение возможно есть что-то что подойдет в качестве названия

NOTE: 

---

Фотка Creevey

- Colin Creevey

NOTE: Мелкий пацан который постоянно тусовался с фотиком и пытался зафотать гарри. мы как раз хотим фотать скриншоты наших компонентов. Кажется подходить идеально под название.

---

## Основные фичи

- Интеграция со Storybook
- TypeScript
- Легкий старт
- Удобный diff
- Безумно быстрый (~1800 тестов = ~6 минут)

---

## Как заюзать

- npm install
- Edit config
- npx creevey --ui

---

## Скриншоты/гифки

---

## Не без минусов

- проект в MVP
- Необходим Selenium
- Нет поддержки puppeteer
- Нет некоторых хотелок

---

## Как Creevey помогает Контуру

- Скриншотим продуктовые сторисы
- Интеграционные тесты на контролы

---

## План развития

- Docker + puppeteer
- Framework agnostic
- Storybook addon (tests inside storybook)

---

## CTA

- Встраивайте скриншотные тесты себе
- Можете попробовать
- Приходите контрибьютить

---

## Ссылки

- Презентация
- Creevey
- Доклад Дворнова
- visual testing awesome